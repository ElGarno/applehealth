version: '3.8'

services:
  # One-time import service (run manually when needed)
  apple_health_import:
    build:
      context: .
      dockerfile: Dockerfile
    image: apple_health:latest
    platform: linux/amd64
    container_name: apple_health_import
    environment:
      - INFLUXDB_URL=${INFLUXDB_URL:-http://192.168.178.114:8088}
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-apple_health}
    volumes:
      - /volume1/docker/apple_health/data:/data:ro
    command: >
      sh -c "python ingest.py /data/HealthAutoExport-20241201-20251210.json --clean &&
             python ingest.py /data/HealthAutoExport-20251210-20251217.json --incremental"
    restart: "no"
    profiles:
      - import

  # Webhook receiver service (runs continuously)
  apple_health_webhook:
    build:
      context: .
      dockerfile: Dockerfile.webhook
    image: apple_health_webhook:latest
    platform: linux/amd64
    container_name: apple_health_webhook
    environment:
      - INFLUXDB_URL=${INFLUXDB_URL:-http://192.168.178.114:8088}
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-apple_health}
      - WEBHOOK_PORT=8080
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-}
      - DATA_DIR=/data
    volumes:
      - /volume1/docker/apple_health/data:/data
    ports:
      - "8085:8080"
    restart: unless-stopped

networks:
  default:
    driver: bridge